{% load cotton %}
{% load crispy_forms_tags %}

<!-- DEBUG: Form template is loading -->
<div class="bg-blue-100 border border-blue-400 rounded p-2 mb-4">
    <p><strong>FORM DEBUG:</strong> modern_profile_form.html is loading!</p>
    <p>Form fields available: {{ form.fields.keys|join:", " }}</p>
</div>

<!-- Profile Form with Cotton Integration and Three-Color Compliance -->
<form id="enterprise-profile-form" 
      hx-post="{% url 'accounts:modern_profile_edit' %}" 
      hx-target="#profile-form-container" 
      hx-swap="innerHTML"
      hx-indicator="#form-loading"
      class="space-y-6">
    
    {% csrf_token %}
    
    <!-- Loading Indicator -->
    <div id="form-loading" class="htmx-indicator fixed top-4 right-4 z-50">
        <div class="bg-white rounded-lg shadow-lg p-3 border border-enterprise-gray-200">
            <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-professional-blue-primary"></div>
                <span class="text-sm text-enterprise-secondary">Updating profile...</span>
            </div>
        </div>
    </div>

    <!-- Personal Information Section -->
    {% c card title="Personal Information" variant="default" %}
        
        <!-- Real-time Compliance Status -->
        <div id="personal-info-compliance" 
             hx-get="{% url 'accounts:field_compliance_check' %}" 
             hx-trigger="change from:input, keyup delay:1s from:input"
             hx-include="closest form"
             class="mb-4">
            <!-- Compliance status for this section -->
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- First Name with Compliance Indicator -->
            <div class="form-field-container" data-field="first_name">
                <label for="id_first_name" class="block text-sm font-medium text-enterprise-black mb-1">
                    First Name
                </label>
                <div class="relative">
                    {{ form.first_name }}
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-3">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.first_name.help_text %}
                    <p class="mt-1 text-xs text-enterprise-secondary">{{ form.first_name.help_text }}</p>
                {% endif %}
                {% if form.first_name.errors %}
                    <div class="mt-1">
                        {% for error in form.first_name.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Last Name -->
            <div class="form-field-container" data-field="last_name">
                <label for="id_last_name" class="block text-sm font-medium text-enterprise-black mb-1">
                    Last Name
                </label>
                <div class="relative">
                    {{ form.last_name }}
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-3">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.last_name.help_text %}
                    <p class="mt-1 text-xs text-enterprise-secondary">{{ form.last_name.help_text }}</p>
                {% endif %}
                {% if form.last_name.errors %}
                    <div class="mt-1">
                        {% for error in form.last_name.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Phone -->
            <div class="form-field-container" data-field="phone">
                <label for="id_phone" class="block text-sm font-medium text-enterprise-black mb-1">
                    Phone
                </label>
                <div class="relative">
                    {{ form.phone }}
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-3">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.phone.help_text %}
                    <p class="mt-1 text-xs text-enterprise-secondary">{{ form.phone.help_text }}</p>
                {% endif %}
                {% if form.phone.errors %}
                    <div class="mt-1">
                        {% for error in form.phone.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Date of Birth -->
            <div class="form-field-container" data-field="date_of_birth">
                <label for="id_date_of_birth" class="block text-sm font-medium text-enterprise-black mb-1">
                    Date of Birth
                </label>
                <div class="relative">
                    {{ form.date_of_birth }}
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-3">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.date_of_birth.help_text %}
                    <p class="mt-1 text-xs text-enterprise-secondary">{{ form.date_of_birth.help_text }}</p>
                {% endif %}
                {% if form.date_of_birth.errors %}
                    <div class="mt-1">
                        {% for error in form.date_of_birth.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
        </div>
    {% endc %}

    <!-- Profile Settings Section -->
    {% c card title="Profile Settings" variant="default" %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Profile Type (Read-only, displayed in header) -->
            <div class="form-field-container" data-field="profile_type_display">
                <label class="block text-sm font-medium text-enterprise-black mb-1">
                    Profile Type
                </label>
                <div class="relative">
                    <div class="block w-full px-3 py-2 text-sm rounded-md border-enterprise-gray-300 bg-gray-50 text-enterprise-black">
                        {{ profile.profile_type.name|default:"General User" }}
                    </div>
                </div>
                <p class="mt-1 text-xs text-enterprise-secondary">Contact administrator to change profile type</p>
            </div>
            
            <!-- Profile Image -->
            <div class="form-field-container" data-field="image">
                <label for="id_image" class="block text-sm font-medium text-enterprise-black mb-1">
                    Profile Image
                </label>
                <div class="relative">
                    {{ form.image }}
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-3">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.image.help_text %}
                    <p class="mt-1 text-xs text-enterprise-secondary">{{ form.image.help_text }}</p>
                {% endif %}
                {% if form.image.errors %}
                    <div class="mt-1">
                        {% for error in form.image.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
        </div>
    {% endc %}

    <!-- Geographical Information Section -->
    {% c card title="Location Information" variant="default" %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Country Selection -->
            <div class="form-field-container" data-field="country">
                <label for="id_country" class="block text-sm font-medium text-enterprise-black mb-1">
                    Country <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                    <select name="{{ form.country.name }}" 
                            id="id_country"
                            autocomplete="country"
                            hx-get="{% url 'accounts:state_options' %}"
                            hx-target="#id_state"
                            hx-include="this"
                            class="block w-full px-3 py-2 border border-enterprise-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-professional-blue-primary focus:border-professional-blue-primary bg-white text-enterprise-black">
                        <option value="">Select Country</option>
                        {% for choice in form.country.field.queryset %}
                            <option value="{{ choice.pk }}" {% if choice.pk == form.country.value %}selected{% endif %}>
                                {{ choice.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-8">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.country.errors %}
                    <div class="mt-1">
                        {% for error in form.country.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- State Selection -->
            <div class="form-field-container" data-field="state">
                <label for="id_state" class="block text-sm font-medium text-enterprise-black mb-1">
                    State/Province <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                    <select name="{{ form.state.name }}" 
                            id="id_state"
                            autocomplete="address-level1"
                            hx-get="{% url 'accounts:city_options' %}"
                            hx-target="#id_city_direct"
                            hx-include="this, [name='country']"
                            class="block w-full px-3 py-2 border border-enterprise-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-professional-blue-primary focus:border-professional-blue-primary bg-white text-enterprise-black">
                        <option value="">Select State/Territory</option>
                        {% for choice in form.state.field.queryset %}
                            <option value="{{ choice.pk }}" {% if choice.pk == form.state.value %}selected{% endif %}>
                                {{ choice.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-8">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.state.errors %}
                    <div class="mt-1">
                        {% for error in form.state.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- City Selection -->
            <div class="form-field-container" data-field="city">
                <label for="id_city_direct" class="block text-sm font-medium text-enterprise-black mb-1">
                    City <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                    <select name="{{ form.city.name }}" 
                            id="id_city_direct"
                            autocomplete="address-level2"
                            class="block w-full px-3 py-2 border border-enterprise-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-professional-blue-primary focus:border-professional-blue-primary bg-white text-enterprise-black">
                        <option value="">Select City</option>
                        {% for choice in form.city.field.queryset %}
                            <option value="{{ choice.pk }}" {% if choice.pk == form.city.value %}selected{% endif %}>
                                {{ choice.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-8">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.city.errors %}
                    <div class="mt-1">
                        {% for error in form.city.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Manual Postal Code -->
            <div class="form-field-container" data-field="postal_code">
                <label for="id_postal_code_manual" class="block text-sm font-medium text-enterprise-black mb-1">
                    Postal Code
                </label>
                <div class="relative">
                    {{ form.postal_code }}
                    <div class="compliance-indicator absolute inset-y-0 right-0 flex items-center pr-3">
                        <!-- Compliance status icon loads here via HTMX -->
                    </div>
                </div>
                {% if form.postal_code.help_text %}
                    <p class="mt-1 text-xs text-enterprise-secondary">{{ form.postal_code.help_text }}</p>
                {% endif %}
                {% if form.postal_code.errors %}
                    <div class="mt-1">
                        {% for error in form.postal_code.errors %}
                            <p class="text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
        </div>
    {% endc %}

    <!-- Tax Information Section (Conditional) -->
    <div id="tax-information-section" 
         hx-get="{% url 'accounts:tax_info_section' %}"
         hx-trigger="load"
         data-profile-type="{{ profile.profile_type.code }}">
        <!-- Tax information section loads here based on profile type -->
    </div>

    <!-- Aviation Information Section (Conditional for Pilots) -->
    <div id="aviation-information-section" 
         hx-get="{% url 'accounts:aviation_info_section' %}"
         hx-trigger="load"
         data-profile-type="{{ profile.profile_type.code }}">
        <!-- Aviation information section loads here for pilot profiles -->
    </div>

    <!-- Form Actions -->
    <div class="flex justify-between items-center pt-6 border-t border-enterprise-gray-200">
        
        <!-- Overall Compliance Status -->
        <div id="overall-compliance-status" 
             hx-get="{% url 'accounts:overall_compliance_status' %}"
             hx-trigger="load, refresh from:body"
             hx-include="closest form">
            <!-- Overall form compliance status displays here -->
        </div>
        
        <!-- Action Buttons -->
        <div class="flex space-x-3">
            
            <!-- Cancel Button -->
            {% c button variant="secondary" type="button" onclick="window.location.href='{% url 'accounts:dashboard' %}'" %}
                Cancel
            {% endc %}
            
            <!-- Save Button -->
            {% c button variant="primary" type="submit" %}
                <div class="flex items-center space-x-2">
                    <span>Update Profile</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            {% endc %}
            
        </div>
    </div>

</form>

<!-- Custom JavaScript for Enhanced UX -->
<script>
    // Enhanced form interaction handling
    document.addEventListener('DOMContentLoaded', function() {
        
        // Add focus ring enhancements for accessibility
        const formFields = document.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            field.addEventListener('focus', function() {
                this.closest('.form-field-container')?.classList.add('field-focused');
            });
            
            field.addEventListener('blur', function() {
                this.closest('.form-field-container')?.classList.remove('field-focused');
            });
        });
        
        // Enhanced compliance status updates
        document.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.target.classList.contains('compliance-indicator')) {
                // Trigger overall status update after individual field compliance check
                setTimeout(() => {
                    htmx.trigger('#overall-compliance-status', 'refresh');
                }, 100);
            }
        });
        
        // Profile type change handling
        document.addEventListener('change', function(event) {
            if (event.target.name === 'profile_type') {
                // Clear conditional sections when profile type changes
                const taxSection = document.getElementById('tax-information-section');
                const aviationSection = document.getElementById('aviation-information-section');
                
                if (taxSection) {
                    taxSection.innerHTML = '<div class="text-center py-4 text-enterprise-secondary">Loading...</div>';
                }
                if (aviationSection) {
                    aviationSection.innerHTML = '<div class="text-center py-4 text-enterprise-secondary">Loading...</div>';
                }
            }
        });
        
    });
</script>